#!/usr/bin/bash -x

set -o errexit -o nounset -o pipefail # -o xtrace

readonly apptainer_image=/cluster/opt/OOD/fox-cryosparc-"<%= context.cryosparc_version %>".sif

export FOX_ACCEL_AUTO_LONG=1

# Fill in correct values in the slurm submit script template
CLUSTER_INFO="$PWD/cluster_info.json"
CLUSTER_SCRIPT="$PWD/cluster_script.sh"
ACCOUNT_ID=$(echo "<%= context.auto_accounts %>" | sed 's/\"//g')
sed -i 's/ACCOUNT_ID/'$ACCOUNT_ID'/g' "$CLUSTER_SCRIPT"


# CryoSPARC license
#
export APPTAINERENV_CRYOSPARC_LICENSE_ID="<%= context.cryosparc_license %>"
export APPTAINERENV_CRYOSPARC_DB_ENABLE_AUTH=false
export APPTAINERENV_CRYOSPARC_FORCE_HOSTNAME=true
export APPTAINERENV_CRYOSPARC_BASE_PORT=${port} # ${port}...${port}+7 will be used
export APPTAINERENV_CRYOSPARC_DEVELOP=false
export APPTAINERENV_CRYOSPARC_INSECURE=false
export APPTAINERENV_CRYOSPARC_CLICK_WRAP=true
if [ ${SLURM_GPUS:-0} -gt 0 ]
then
  export APPTAINERENV_CRYOSPARC_USE_GPU=true
  export APPTAINER_NV=true
else
  export APPTAINERENV_CRYOSPARC_USE_GPU=false
  export APPTAINER_NV=false
fi
export APPTAINERENV_PYTHONNOUSERSITE=1
export APPTAINERENV_USER=$(id -un)
export APPTAINER_CLEANENV=true

cryosparc_user_path=$HOME/cryosparc

export PROJDIR="/fp/projects01/<%= context.auto_accounts %>"
export APPTAINERENV_CRYOSPARC_DB_PATH=${cryosparc_user_path}/database

readonly cryosparc_user_password="<%= context.cryosparc_user_password %>"

mkdir -p ${cryosparc_user_path}/run

tmpdir=$(mktemp -d)
export APPTAINER_BIND="${tmpdir}:/tmp:rw,$PROJDIR:$PROJDIR:rw,$SCRATCH:$SCRATCH:rw,${cryosparc_user_path}/run:/cryosparc/cryosparc_master/run:rw"

cryosparcm() {
  apptainer exec instance://cryosparc cryosparcm "$@"
}

cryosparcw() {
  apptainer exec instance://cryosparc cryosparcw "$@"
}

# An instance is used to support sites that use non-setuid mode, to avoid
# squashfuse_ll terminating prematurely when supervisord daemonizes
apptainer instance start --nv "${apptainer_image}" cryosparc

if [ ! -e "${APPTAINERENV_CRYOSPARC_DB_PATH}" ]
then
  new_db=true
else
  new_db=false
fi

if ${new_db}
then
  cryosparcm start
  # initial setup for new database
  # Add a user account for the webapp
  cryosparcm createuser \
    --email "${APPTAINERENV_USER}@educloud.no" \
    --password "${cryosparc_user_password}" \
    --username "${APPTAINERENV_USER}" \
    --firstname "${APPTAINERENV_USER}" \
    --lastname "${APPTAINERENV_USER}"  
else
# adapted from `cryosparcm changeport``
  cryosparcm start database
  cryosparcm checkdb > /dev/null 2>&1 || echo "Reconfiguring database." && cryosparcm fixdbport
  cryosparcm restart
  cryosparcm checkdb
  cryosparcm cli "reset_password('${APPTAINERENV_USER}@educloud.no', '${cryosparc_user_password}')"
fi

# "cryosparw connect --update" doesn't work if the hostname has changed
cryosparcm cli 'remove_scheduler_lane("default")'

# Prepare job submission cluster
cryosparcm cluster connect \
  --cluster "$CLUSTER_INFO" \
  --cluster-script "$CLUSTER_SCRIPT"

cryosparcw connect --ssdpath=$SCRATCH --master $(uname -n) --worker $(uname -n) --port ${APPTAINERENV_CRYOSPARC_BASE_PORT}
# Restrict CPU & memory to Slurm-allocated amount.
# Can only be set with --update, not on initial connect:
# https://discuss.cryosparc.com/t/error-assigning-cpus-to-worker/9875/3
cryosparcw connect --ssdpath=$SCRATCH --master $(uname -n) --worker $(uname -n) --port ${APPTAINERENV_CRYOSPARC_BASE_PORT} --update --cpus ${SLURM_CPUS_PER_TASK} --rams $((SLURM_MEM_PER_NODE/8000))


# https://guide.cryosparc.com/setup-configuration-and-management/software-system-guides/guide-installation-testing-with-cryosparcm-test
# doesn't take long to run; enabled to serve as a sanity check
APPTAINERENV_TERM=dumb cryosparcm test install
##### uncomment below to test gpu / tensorflow / pytorch (after creating a project)
#CRYOSPARC_TEST_PROJECT=P2 # create this project before testing
#APPTAINERENV_TERM=dumb cryosparcm test workers ${CRYOSPARC_TEST_PROJECT} --test gpu --test-tensorflow --test-pytorch
##### uncomment above to test

# FIXME
cryosparcm status

# TODO: wait until cryosparcm's python process exits instead
sleep infinity
